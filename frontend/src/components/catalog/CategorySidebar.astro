---
import { getCategorias } from "../../lib/directus";
import type { Categoria } from "../../lib/types";
import { formatCategoryName } from "../../lib/utils";
import CategoryIcon from "./CategoryIcon.astro";

interface Props {
  mode?: "root" | "children";
  currentCategorySlug?: string;
}

const { mode, currentCategorySlug } = Astro.props as Props;
const allCategorias = await getCategorias();

function getParentId(cat: Categoria): number | null {
  const raw = typeof cat.parent === "object" ? cat.parent?.id : cat.parent;
  if (raw === null || raw === undefined || raw === "") return null;
  return Number(raw);
}

const currentPath = Astro.url.pathname;
const routeCategorySlug = currentPath.startsWith("/categoria/")
  ? currentPath.split("/")[2] || null
  : null;
const categorySlug = currentCategorySlug || routeCategorySlug;
const isCatalogRoot =
  mode === "root" ? true : mode === "children" ? false : currentPath.startsWith("/catalogo");

function dedupeByName(cats: Categoria[]): Categoria[] {
  return cats.filter((cat, index, all) => {
    const key = formatCategoryName(cat.nombre).toLowerCase();
    return (
      all.findIndex(
        (candidate) => formatCategoryName(candidate.nombre).toLowerCase() === key
      ) === index
    );
  });
}

const topLevel = dedupeByName(
  allCategorias.filter((c) => getParentId(c) === null)
);

const currentCategory = categorySlug
  ? allCategorias.find((cat) => cat.slug === categorySlug) || null
  : null;

const childCategories = currentCategory
  ? dedupeByName(
      allCategorias.filter((cat) => getParentId(cat) === Number(currentCategory.id))
    )
  : [];

// When no subcategories, find sibling categories (same parent)
const parentId = currentCategory ? getParentId(currentCategory) : null;
const parentCategory = parentId
  ? allCategorias.find((c) => Number(c.id) === parentId) || null
  : null;

const siblingCategories = parentId
  ? dedupeByName(
      allCategorias.filter((cat) => getParentId(cat) === parentId)
    )
  : [];

// Determine what to show
const hasChildren = childCategories.length > 0;
const hasSiblings = siblingCategories.length > 0;

let sidebarTitle: string;
let itemsToShow: Categoria[];
let backLink: { label: string; href: string } | null = null;

if (isCatalogRoot) {
  sidebarTitle = "Categorias";
  itemsToShow = topLevel;
} else if (hasChildren) {
  // Current category has subcategories → show them
  sidebarTitle = `Subcategorias de ${formatCategoryName(currentCategory!.nombre)}`;
  itemsToShow = childCategories;
  backLink = parentCategory
    ? { label: `← ${formatCategoryName(parentCategory.nombre)}`, href: `/categoria/${parentCategory.slug}` }
    : { label: "← Todas las categorias", href: "/catalogo" };
} else if (hasSiblings && parentCategory) {
  // No subcategories but has siblings → show sibling categories
  sidebarTitle = formatCategoryName(parentCategory.nombre);
  itemsToShow = siblingCategories;
  backLink = { label: "← Todas las categorias", href: "/catalogo" };
} else {
  // Top-level category with no children → show all top-level
  sidebarTitle = "Categorias";
  itemsToShow = topLevel;
}
---

<nav class="bg-white border border-border rounded-lg overflow-hidden">
  <p class="px-4 py-3 text-sm font-bold text-navy bg-bg-light border-b border-border">
    {sidebarTitle}
  </p>
  {itemsToShow.length > 0 ? (
    <ul class="py-1">
      {itemsToShow.map((cat) => {
        const isActive = currentPath.includes(`/categoria/${cat.slug}`);
        return (
          <li>
            <a
              href={`/categoria/${cat.slug}`}
              class:list={[
                "flex items-center gap-2 px-4 py-2 text-sm transition-colors",
                isActive
                  ? "text-action font-medium bg-bg-accent"
                  : "text-navy hover:text-action hover:bg-bg-light",
              ]}
            >
              <CategoryIcon slug={cat.slug} className="w-4 h-4 text-action" />
              <span>{formatCategoryName(cat.nombre)}</span>
            </a>
          </li>
        );
      })}
    </ul>
  ) : (
    <div class="px-4 py-3 text-sm text-text-muted">
      No hay categorias disponibles.
    </div>
  )}
  {backLink && (
    <div class="px-4 py-3 border-t border-border bg-white">
      <a href={backLink.href} class="text-sm text-action hover:underline">
        {backLink.label}
      </a>
    </div>
  )}
  {!isCatalogRoot && !backLink && (
    <div class="px-4 py-3 border-t border-border bg-white">
      <a href="/catalogo" class="text-sm text-action hover:underline">
        Ver categorias principales
      </a>
    </div>
  )}
</nav>
