---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Breadcrumb from "../../components/ui/Breadcrumb.astro";
import { getProductoBySlug, getAssetUrl, getTarifasForGrupo } from "../../lib/directus";
import { resolveDiscount, calculatePrice, formatCurrency } from "../../lib/pricing";
import type { TarifaEspecial, Categoria } from "../../lib/types";

const { slug } = Astro.params;
const product = await getProductoBySlug(slug!);

if (!product) {
  return Astro.redirect("/catalogo");
}

const user = Astro.locals.user;
const token = Astro.locals.token;
let finalPrice: number | null = null;
let descuento = 0;

if (user?.grupo_cliente && token) {
  const tarifas = await getTarifasForGrupo(user.grupo_cliente, token);
  const categoriaId = typeof product.categoria === "object" ? (product.categoria as Categoria)?.id : product.categoria;
  descuento = resolveDiscount(tarifas, product.id, categoriaId);
  finalPrice = calculatePrice(product.precio_base, descuento);
}

const imageUrl = getAssetUrl(product.imagen_principal, { width: 600, height: 600 });
const categoria = product.categoria as Categoria | null;
const marcaNombre = typeof product.marca_id === "object" && product.marca_id ? product.marca_id.nombre : product.marca;

const breadcrumbs = [];
if (categoria) {
  breadcrumbs.push({ label: categoria.nombre, href: `/categoria/${categoria.slug}` });
}
breadcrumbs.push({ label: product.nombre });
---

<BaseLayout title={`${product.nombre} - Tienda Alcora`}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <Breadcrumb items={breadcrumbs} />

    <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-8">
      {/* Image */}
      <div class="bg-bg-light rounded-lg p-8 flex items-center justify-center">
        {product.imagen_principal ? (
          <img
            src={imageUrl}
            alt={product.nombre}
            class="max-w-full max-h-[500px] object-contain"
          />
        ) : (
          <div class="text-border">
            <svg class="w-32 h-32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </div>
        )}
      </div>

      {/* Details */}
      <div>
        <p class="text-sm text-text-muted mb-1">SKU: {product.sku}</p>
        {marcaNombre && (
          <p class="text-xs font-semibold text-action/80 uppercase tracking-wide mb-1">{marcaNombre}</p>
        )}
        <h1 class="text-2xl font-bold text-navy mb-4">{product.nombre}</h1>

        {product.formato && (
          <p class="text-sm text-text-muted mb-2">
            <strong>Formato:</strong> {product.formato}
          </p>
        )}

        {product.unidad_venta && (
          <p class="text-sm text-text-muted mb-4">
            <strong>Unidad de venta:</strong> {product.unidad_venta}
          </p>
        )}

        {/* Price */}
        <div class="border-t border-b border-border py-4 my-4">
          {finalPrice !== null ? (
            <div>
              {descuento > 0 && (
                <p class="text-sm text-text-muted line-through">
                  PVP: {formatCurrency(product.precio_base)}
                </p>
              )}
              <p class="text-3xl font-bold text-action">
                {formatCurrency(finalPrice)}
              </p>
              {descuento > 0 && (
                <span class="inline-block mt-1 px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-medium">
                  -{descuento}% dto. {user?.grupo_cliente}
                </span>
              )}
            </div>
          ) : (
            <div class="bg-bg-accent p-4 rounded-lg">
              <p class="text-sm text-navy font-medium">
                <a href="/login" class="text-action hover:underline">Acceda a su cuenta</a>
                {" "}para ver precios y realizar pedidos.
              </p>
              <p class="text-xs text-text-muted mt-1">
                No tiene cuenta? <a href="/registro" class="text-action hover:underline">Solicite acceso</a>
              </p>
            </div>
          )}
        </div>

        {/* Add to cart - only if logged in with price */}
        {finalPrice !== null && (
          <div class="mb-6" id="add-to-cart-section"
            data-product-id={product.id}
            data-product-name={product.nombre}
            data-product-sku={product.sku}
            data-product-slug={product.slug}
            data-product-image={product.imagen_principal || ""}
            data-product-price={finalPrice}
            data-product-formato={product.formato || ""}
          >
            <div class="flex items-center gap-3">
              <div class="flex items-center border border-border rounded-lg">
                <button id="qty-minus" class="px-3 py-2 text-navy hover:bg-bg-light transition-colors">-</button>
                <input id="qty-input" type="number" value="1" min="1" class="w-16 text-center py-2 border-x border-border text-sm" />
                <button id="qty-plus" class="px-3 py-2 text-navy hover:bg-bg-light transition-colors">+</button>
              </div>
              <button
                id="btn-add-cart"
                class="flex-1 bg-action text-white py-2.5 rounded-lg text-sm font-medium hover:bg-action-hover transition-colors"
              >
                Anadir al carrito
              </button>
            </div>
          </div>
        )}

        {/* Technical sheets */}
        <div class="space-y-2">
          {product.ficha_tecnica && (
            <a
              href={getAssetUrl(product.ficha_tecnica)}
              target="_blank"
              rel="noopener"
              class="flex items-center gap-2 px-4 py-2.5 border border-border rounded-lg text-sm text-navy hover:bg-bg-light transition-colors"
            >
              <svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
              </svg>
              Descargar Ficha Tecnica (PDF)
            </a>
          )}
          {product.ficha_seguridad && (
            <a
              href={getAssetUrl(product.ficha_seguridad)}
              target="_blank"
              rel="noopener"
              class="flex items-center gap-2 px-4 py-2.5 border border-border rounded-lg text-sm text-navy hover:bg-bg-light transition-colors"
            >
              <svg class="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
              </svg>
              Descargar Ficha de Seguridad (PDF)
            </a>
          )}
        </div>

        {/* Stock */}
        <div class="mt-4">
          {product.stock === 0 ? (
            <span class="text-sm text-red-600 font-medium">Sin stock</span>
          ) : product.stock > 0 ? (
            <span class="text-sm text-green-600 font-medium">En stock ({product.stock} uds)</span>
          ) : (
            <span class="text-sm text-green-600 font-medium">Disponible</span>
          )}
        </div>
      </div>
    </div>

    {/* Description */}
    {product.descripcion && (
      <div class="mt-12 border-t border-border pt-8">
        <h2 class="text-lg font-bold text-navy mb-4">Descripcion</h2>
        <div class="prose prose-sm max-w-none text-text-muted" set:html={product.descripcion} />
      </div>
    )}
  </div>
</BaseLayout>

<script>
  // Client-side: Add to cart logic
  const section = document.getElementById("add-to-cart-section");
  if (section) {
    const btn = document.getElementById("btn-add-cart");
    const qtyInput = document.getElementById("qty-input") as HTMLInputElement;
    const qtyMinus = document.getElementById("qty-minus");
    const qtyPlus = document.getElementById("qty-plus");

    qtyMinus?.addEventListener("click", () => {
      const val = parseInt(qtyInput.value) || 1;
      if (val > 1) qtyInput.value = String(val - 1);
    });

    qtyPlus?.addEventListener("click", () => {
      const val = parseInt(qtyInput.value) || 1;
      qtyInput.value = String(val + 1);
    });

    btn?.addEventListener("click", async () => {
      const { addToCart } = await import("../../stores/cart");

      addToCart({
        productoId: section.dataset.productId!,
        nombre: section.dataset.productName!,
        sku: section.dataset.productSku!,
        slug: section.dataset.productSlug!,
        imagen: section.dataset.productImage || null,
        cantidad: parseInt(qtyInput.value) || 1,
        precioUnitario: parseFloat(section.dataset.productPrice!),
        formato: section.dataset.productFormato || null,
      });

      // Show toast notification
      const productName = section.dataset.productName || "Producto";
      const qty = parseInt(qtyInput.value) || 1;
      if (window.showToast) {
        window.showToast(
          qty > 1
            ? `${qty} x ${productName} anadido al carrito`
            : `${productName} anadido al carrito`,
          "success"
        );
      }

      btn.textContent = "Anadido!";
      btn.classList.add("bg-green-600");
      setTimeout(() => {
        btn.textContent = "Anadir al carrito";
        btn.classList.remove("bg-green-600");
      }, 2000);
    });
  }
</script>
