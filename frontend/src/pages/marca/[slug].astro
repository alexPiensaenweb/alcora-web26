---
import CatalogLayout from "../../layouts/CatalogLayout.astro";
import InfiniteProductGrid from "../../components/catalog/InfiniteProductGrid";
import { getAssetUrl, getMarcaBySlug, getProductos, getTarifasForGrupo, getPublicAssetUrl } from "../../lib/directus";
import { calculatePrice, resolveDiscount } from "../../lib/pricing";
import type { TarifaEspecial } from "../../lib/types";

const { slug } = Astro.params;
let marca;
try {
  marca = await getMarcaBySlug(slug!);
} catch (error) {
  console.error("[marca] Error fetching marca:", error);
}

if (!marca) {
  return Astro.redirect("/catalogo");
}

const limit = 24;
let products: any[] = [];
let meta: { total_count: number } = { total_count: 0 };
try {
  const result = await getProductos({
    marcaId: marca.id,
    page: 1,
    limit,
  });
  products = result.data;
  meta = result.meta;
} catch (error) {
  console.error("[marca] Error fetching products for marca:", error);
}

const user = Astro.locals.user;
const token = Astro.locals.token;
let tarifas: TarifaEspecial[] = [];

if (user?.grupo_cliente && token) {
  tarifas = await getTarifasForGrupo(user.grupo_cliente, token);
}

const initialItems = products.map((product: any) => {
  const categoriaId =
    typeof product.categoria === "object"
      ? product.categoria?.id
      : product.categoria;

  let price: number | null = null;
  if (user) {
    if (tarifas.length > 0) {
      const descuento = resolveDiscount(tarifas, product.id, categoriaId || null);
      price = calculatePrice(product.precio_base, descuento);
    } else {
      price = product.precio_base;
    }
  }

  return {
    id: product.id,
    sku: product.sku,
    nombre: product.nombre,
    slug: product.slug,
    extracto: product.extracto || null,
    formato: product.formato || null,
    imageUrl: getAssetUrl(product.imagen_principal, {
      width: 480,
      height: 480,
      fit: "contain",
    }),
    price,
  };
});

const apiUrl = `/api/products?limit=${limit}&marca_id=${marca.id}`;
const totalProducts = meta?.total_count || 0;
const siteUrl = process.env.PUBLIC_SITE_URL || import.meta.env.PUBLIC_SITE_URL || "https://tienda.alcora.es";

// JSON-LD Brand schema
const brandSchema = {
  "@context": "https://schema.org",
  "@type": "Brand",
  name: marca.nombre,
  url: `${siteUrl}/marca/${marca.slug}`,
  ...(marca.logo ? { logo: getPublicAssetUrl(marca.logo) } : {}),
  ...(marca.web ? { sameAs: marca.web } : {}),
};

// JSON-LD CollectionPage schema
const collectionSchema = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  name: `Productos ${marca.nombre} - Alcora Salud Ambiental`,
  description: `Catalogo de productos profesionales ${marca.nombre} para control de plagas, desinfeccion e higiene ambiental. Distribuidor oficial.`,
  url: `${siteUrl}/marca/${marca.slug}`,
  numberOfItems: totalProducts,
  provider: {
    "@type": "Organization",
    name: "Alcora Salud Ambiental",
    url: siteUrl,
  },
};
---

<CatalogLayout
  title={`${marca.nombre} - Productos profesionales | Tienda Alcora`}
  description={`Catalogo completo de productos ${marca.nombre} para profesionales del control de plagas, desinfeccion e higiene ambiental. ${totalProducts} productos disponibles. Distribuidor oficial.`}
  breadcrumbs={[
    { label: "Marcas", href: "/marcas" },
    { label: marca.nombre },
  ]}
  sidebarMode="root"
>
  <div>
    {/* Brand header */}
    <div class="flex items-start gap-5 mb-6">
      {marca.logo && (
        <div class="w-20 h-20 bg-white border border-border rounded-xl p-2 flex-shrink-0 flex items-center justify-center">
          <img
            src={getPublicAssetUrl(marca.logo)}
            alt={`Logo ${marca.nombre}`}
            class="max-w-full max-h-full object-contain"
          />
        </div>
      )}
      <div class="flex-1">
        <h1 class="text-xl font-bold text-navy">{marca.nombre}</h1>
        <p class="text-sm text-text-muted mt-1">
          {totalProducts} productos profesionales disponibles
        </p>
        {marca.web && (
          <a
            href={marca.web}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-1 text-xs text-action hover:underline mt-2"
          >
            Sitio web oficial
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
          </a>
        )}
      </div>
    </div>

    {/* SEO content block */}
    <div class="prose prose-sm max-w-none text-text-muted mb-6">
      <p>
        Distribuimos toda la gama de productos <strong>{marca.nombre}</strong> para profesionales
        del sector de la sanidad ambiental, control de plagas y limpieza profesional. Como distribuidor
        oficial, garantizamos producto original, stock inmediato y las mejores condiciones para empresas.
      </p>
    </div>

    <InfiniteProductGrid
      client:load
      apiUrl={apiUrl}
      initialItems={initialItems}
      initialPage={1}
      initialHasMore={totalProducts > limit}
    />
  </div>

  {/* Schema.org structured data */}
  <script type="application/ld+json" set:html={JSON.stringify(brandSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(collectionSchema)} />
</CatalogLayout>
