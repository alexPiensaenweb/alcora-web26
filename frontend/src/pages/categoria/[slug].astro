---
import CatalogLayout from "../../layouts/CatalogLayout.astro";
import InfiniteProductGrid from "../../components/catalog/InfiniteProductGrid";
import { getAssetUrl, getCategoriaBySlug, getCategorias, getProductos, getTarifasForGrupo } from "../../lib/directus";
import { calculatePrice, resolveDiscount } from "../../lib/pricing";
import { formatCategoryName } from "../../lib/utils";
import type { TarifaEspecial, Categoria } from "../../lib/types";

const { slug } = Astro.params;
const categoria = await getCategoriaBySlug(slug!);

if (!categoria) {
  return Astro.redirect("/catalogo");
}

const url = Astro.url;
const limit = 24;

const allCategorias = await getCategorias();

function collectDescendantIds(
  rootId: number,
  categorias: Categoria[]
): number[] {
  const ids: number[] = [rootId];
  const queue: number[] = [rootId];

  while (queue.length > 0) {
    const current = queue.shift()!;
    const children = categorias.filter((cat) => {
      const parentId = typeof cat.parent === "object" ? cat.parent?.id : cat.parent;
      return parentId === current;
    });

    for (const child of children) {
      if (!ids.includes(child.id)) {
        ids.push(child.id);
        queue.push(child.id);
      }
    }
  }

  return ids;
}

const categoriaIds = collectDescendantIds(categoria.id, allCategorias);
const { data: products, meta } = await getProductos({
  categoriaIds,
  page: 1,
  limit,
});

const user = Astro.locals.user;
const token = Astro.locals.token;
let tarifas: TarifaEspecial[] = [];

if (user?.grupo_cliente && token) {
  tarifas = await getTarifasForGrupo(user.grupo_cliente, token);
}

const initialItems = products.map((product: any) => {
  const categoriaId =
    typeof product.categoria === "object"
      ? product.categoria?.id
      : product.categoria;

  let price: number | null = null;
  if (user) {
    if (tarifas.length > 0) {
      const descuento = resolveDiscount(tarifas, product.id, categoriaId || null);
      price = calculatePrice(product.precio_base, descuento);
    } else {
      price = product.precio_base;
    }
  }

  return {
    id: product.id,
    sku: product.sku,
    nombre: product.nombre,
    slug: product.slug,
    extracto: product.extracto || null,
    formato: product.formato || null,
    imageUrl: getAssetUrl(product.imagen_principal, {
      width: 480,
      height: 480,
      fit: "contain",
    }),
    price,
  };
});

const apiUrl = `/api/products?limit=${limit}&categoria=${encodeURIComponent(slug!)}`;

const parentCat = categoria.parent as Categoria | null;
const breadcrumbs = [];
if (parentCat) {
  breadcrumbs.push({
    label: formatCategoryName(parentCat.nombre),
    href: `/categoria/${parentCat.slug}`,
  });
}
breadcrumbs.push({ label: formatCategoryName(categoria.nombre) });

// Subcategories for internal linking
const childCats = allCategorias.filter((cat) => {
  const parentId = typeof cat.parent === "object" ? cat.parent?.id : cat.parent;
  return parentId === categoria.id;
});

const totalProducts = meta?.total_count || 0;
const categoryName = formatCategoryName(categoria.nombre);
const siteUrl = import.meta.env.PUBLIC_SITE_URL || "https://tienda.alcora.es";

// SEO description
const seoDescription = categoria.descripcion
  ? categoria.descripcion.replace(/<[^>]+>/g, "").slice(0, 155)
  : `Comprar ${categoryName} para profesionales. ${totalProducts} productos disponibles con stock inmediato. Distribuidor oficial - Alcora Salud Ambiental.`;

// JSON-LD CollectionPage schema
const collectionSchema = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  name: `${categoryName} - Alcora Salud Ambiental`,
  description: seoDescription,
  url: `${siteUrl}/categoria/${slug}`,
  numberOfItems: totalProducts,
  ...(parentCat ? {
    isPartOf: {
      "@type": "CollectionPage",
      name: formatCategoryName(parentCat.nombre),
      url: `${siteUrl}/categoria/${parentCat.slug}`,
    },
  } : {}),
  provider: {
    "@type": "Organization",
    name: "Alcora Salud Ambiental",
    url: siteUrl,
  },
};

// BreadcrumbList schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Inicio", item: siteUrl },
    { "@type": "ListItem", position: 2, name: "Catalogo", item: `${siteUrl}/catalogo` },
    ...(parentCat ? [{
      "@type": "ListItem",
      position: 3,
      name: formatCategoryName(parentCat.nombre),
      item: `${siteUrl}/categoria/${parentCat.slug}`,
    }] : []),
    {
      "@type": "ListItem",
      position: parentCat ? 4 : 3,
      name: categoryName,
      item: `${siteUrl}/categoria/${slug}`,
    },
  ],
};
---

<CatalogLayout
  title={`${categoryName} - Productos profesionales | Tienda Alcora`}
  description={seoDescription}
  breadcrumbs={breadcrumbs}
  sidebarMode="children"
  currentCategorySlug={slug}
>
  <div>
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-xl font-bold text-navy">{categoryName}</h1>
      <span class="text-sm text-text-muted">
        {totalProducts} productos
      </span>
    </div>

    {categoria.descripcion && (
      <div class="prose prose-sm max-w-none text-text-muted mb-6" set:html={categoria.descripcion} />
    )}

    {/* Subcategories links */}
    {childCats.length > 0 && (
      <div class="flex flex-wrap gap-2 mb-6">
        {childCats.map((child) => (
          <a
            href={`/categoria/${child.slug}`}
            class="inline-flex items-center gap-1 px-3 py-1.5 bg-bg-accent text-action text-sm rounded-full hover:bg-action hover:text-white transition-colors"
          >
            {formatCategoryName(child.nombre)}
          </a>
        ))}
      </div>
    )}

    <InfiniteProductGrid
      client:load
      apiUrl={apiUrl}
      initialItems={initialItems}
      initialPage={1}
      initialHasMore={totalProducts > limit}
    />

    {/* SEO footer text (only if no description from Directus) */}
    {!categoria.descripcion && (
      <div class="mt-12 prose prose-sm max-w-none text-text-muted">
        <h2 class="text-lg font-semibold text-navy">
          {categoryName} para profesionales
        </h2>
        <p>
          En Alcora Salud Ambiental ofrecemos un amplio catalogo de productos de
          <strong> {categoryName.toLowerCase()}</strong> para profesionales del sector.
          Stock inmediato, asesoramiento tecnico y las mejores condiciones para empresas
          del sector de la sanidad ambiental, control de plagas y limpieza profesional.
        </p>
      </div>
    )}
  </div>

  {/* Schema.org structured data */}
  <script type="application/ld+json" set:html={JSON.stringify(collectionSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
</CatalogLayout>
